<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Advanced 3D Model Showcase</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/TextPlugin.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-environment-component/dist/aframe-environment-component.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-orbit-controls@1.3.0/dist/aframe-orbit-controls.min.js"></script>

    <style>
      body {
        font: normal 500 1.2rem/1.2 Inconsolata, Andale Mono, Courier New,
          monospace;
        color: #333;
        background-color: #f5f5f5;
        margin: 0;
        padding: 0;
        overflow: hidden;
      }
      .night-mode-title {
        color: white;
      }

      .zen-mode .info-text {
        color: black;
      }

      .button-title {
        font-size: 16px;
        color: #333;
        padding: 2px;
        margin-top: 10px;
        margin-bottom: 5px;
      }
      .additional-controls {
        position: fixed;
        top: 100px; /* æ ¹æ®éœ€è¦è°ƒæ•´ä½ç½® */
        left: 15px;
        display: flex;
        flex-direction: column;
        align-items: flex-start;
      }

      .logo-container {
        background-image: url("../logo/logo.png");
        background-size: contain;
        background-repeat: no-repeat;
        width: 100px;
        height: 50px;
        position: fixed;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 20;
      }

      /* ç‰ˆæƒæ–‡å­—æ ·å¼ */
      .copyright-text {
        position: fixed;
        bottom: 17px;
        left: 40%;
        transform: translateX(-22%);
        color: white; /* é»˜è®¤é¢œè‰² */
        font-size: 12px;
        z-index: 10;
      }

      /* é€æ˜èƒŒæ™¯æ ·å¼ */
      .transparent-background {
        background-color: rgba(255, 255, 255, 0.8);
      }
      #controls {
        position: fixed;
        top: 15px;
        left: 15px;
        color: white;
        font-family: "Helvetica Neue", Arial, sans-serif; /* ä½¿ç”¨ Apple å®˜ç½‘é£æ ¼çš„å­—ä½“ */
        font-size: 9px; /* è¾ƒå°çš„å­—ä½“å¤§å° */
        line-height: 1.5; /* è¾ƒå°çš„è¡Œé«˜ */
        z-index: 20;
        display: flex;
        align-items: center;
        background-color: #ffffff; /* ç™½è‰²èƒŒæ™¯ */
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1); /* è½»å¾®çš„é˜´å½±æ•ˆæœ */
        margin: 1px; /* ä¸ä¸Šæ–¹å…ƒç´ ç•™å‡ºé—´è· */
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif; /* ç°ä»£å­—ä½“ */
        color: #333; /* æ·±ç°è‰²æ–‡æœ¬ */
        font-size: 12px; /* é€‚ä¸­çš„å­—ä½“å¤§å° */
        opacity: 1;
      }

      #rotation-speed {
        /* å·¦ä¸Šè§’æ–‡å­— */
        flex-grow: 1;
        margin-left: 10px;
        -webkit-appearance: none; /* ç§»é™¤é»˜è®¤æ ·å¼ */
        width: 100%;
        height: 4px;
        background: #ddd; /* æ»‘å—èƒŒæ™¯ */
        outline: none; /* ç§»é™¤è½®å»“ */
        opacity: 0.4; /* è½»å¾®é€æ˜ */
        transition: opacity 0.2s;
        border-radius: 5px; /* åœ†è§’ */
      }

      #rotation-speed::-webkit-slider-thumb {
        -webkit-appearance: none; /* ç§»é™¤é»˜è®¤æ ·å¼ */
        appearance: none;
        width: 20px; /* æ»‘å—å¤§å° */
        height: 20px;
        background: #333; /* æ»‘å—é¢œè‰² */
        cursor: pointer; /* å…‰æ ‡æ ·å¼ */
        border-radius: 50%; /* åœ†å½¢ */
      }

      .info-text {
        /* å³ä¸Šè§’æ–‡å­— */

        position: fixed;
        top: 17px;
        right: 20px;
        color: white;
        font-size: 12px; /* è¾ƒå°çš„å­—ä½“å¤§å° */
        line-height: 0.8; /* è¾ƒå°çš„è¡Œé«˜ */
        padding: 5px;
        margin: 3px;
      }
      .button-container {
        position: absolute;
        left: 12px;
        bottom: 10px;
        z-index: 10;
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        text-transform: uppercase;
      }

      .toggle-button {
        /* å·¦ä¸‹æŒ‰éˆ•æ–‡å­—*/
        background-color: #f5f5f5; /* æ·ºç°è‰²èƒŒæ™¯ */
        color: #333;
        border: 1px solid #d1d1d1; /* æ·ºè‰²é‚Šæ¡† */
        padding: 8px 16px;
        font-size: 11px;
        border-radius: 5px; /* è¼•å¾®çš„åœ“è§’ */
        cursor: pointer;
        transition: all 0.3s ease-in-out;
        margin: 3px 0;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); /* æ›´ç´°è†©çš„é™°å½± */
      }

      .toggle-button:hover {
        background-color: #e6e6e6; /* æ‚¬åœæ—¶çš„èƒŒæ™¯é¢œè‰² */
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); /* æ‚¬åœæ—¶çš„é™°å½± */
      }

      #info-dialog {
        position: fixed;
        width: 300px; /* æˆ–å…¶ä»–å°ºå¯¸ */
        background: rgba(255, 255, 255, 0.8); /* é€æ˜åº¦èƒŒæ™¯ */
        padding: 20px;
        border-radius: 10px;
        display: none; /* é»˜è®¤éšè— */
        /* å…¶ä»–æ ·å¼ */
      }

      /* é©æ‡‰å°å±å¹•çš„æ¨£å¼ */
      @media (max-width: 600px) {
        .toggle-button {
          padding: 6px 12px;
          font-size: 12px;
        }
      }

      .active {
        background-color: #e6e6e6;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      }

      @media (max-width: 620px) {
        .button-container,
        .info-text,
        #controls {
          font-size: 12px; /* æ›´å°çš„å­—ä½“å¤§å° */
          padding: 5px; /* æ›´å°çš„å†…è¾¹è· */
        }

        .toggle-button {
          padding: 6px 12px; /* è°ƒæ•´æŒ‰é’®çš„å†…è¾¹è· */
          margin: 2px 0; /* è°ƒæ•´æŒ‰é’®é—´è· */
        }

        #controls {
          top: 15px; /* åœ¨è¾ƒå°å±å¹•ä¸Šï¼Œè°ƒæ•´ä½ç½® */
        }

        .info-text {
          position: fixed;
          top: calc(
            15px + 40px + 12px
          ); /* Rotate Speed Controller é«˜åº¦ + åˆå§‹é¡¶éƒ¨ä½ç½® + é—´è· */
          left: 12px;
          margin-top: 0; /* ç§»é™¤é¢å¤–çš„é¡¶éƒ¨é—´è· */
        }
      }
    </style>
  </head>
  <body>
    <!-- è¼‰å…¥é€²åº¦æŒ‡ç¤ºå™¨ -->
    <div id="loading-overlay" style="
      position: fixed; 
      width: 100%; 
      height: 100%; 
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); 
      color: white; 
      display: flex; 
      flex-direction: column; 
      justify-content: center; 
      align-items: center; 
      z-index: 9999;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    ">
      <div style="text-align: center;">
        <div style="
          width: 60px; 
          height: 60px; 
          border: 4px solid rgba(255,255,255,0.3); 
          border-radius: 50%; 
          border-top-color: #fff; 
          animation: spin 1s ease-in-out infinite; 
          margin: 0 auto 20px;
        "></div>
        <h2 style="margin: 10px 0; font-weight: 300;">è¼‰å…¥ç¶ è—»ç¼¸æ¨¡å‹</h2>
        <div id="loading-progress" style="
          width: 300px; 
          height: 6px; 
          background-color: rgba(255,255,255,0.2); 
          border-radius: 3px; 
          margin: 20px auto; 
          overflow: hidden;
        ">
          <div id="progress-bar" style="
            width: 0%; 
            height: 100%; 
            background: linear-gradient(90deg, #00ff88, #00d4ff); 
            border-radius: 3px; 
            transition: width 0.3s ease;
          "></div>
        </div>
        <p id="loading-status" style="margin: 5px 0; opacity: 0.8; font-size: 14px;">æ­£åœ¨è¼‰å…¥è³‡æº...</p>
        <button id="skip-loading" style="
          margin-top: 20px;
          padding: 10px 20px;
          background: rgba(255,255,255,0.2);
          border: 1px solid rgba(255,255,255,0.3);
          color: white;
          border-radius: 6px;
          cursor: pointer;
          font-size: 14px;
          display: none;
          transition: all 0.3s ease;
        " onclick="skipLoading()">è·³éè¼‰å…¥</button>
      </div>
    </div>

    <style>
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
    <div class="button-container">
      <!-- Explode Model æŒ‰é’®ç»„ -->
      <div class="button-title dynamic-color" id="explodeModelTitle">
        <strong>Explode Model</strong>
      </div>
      <button
        class="toggle-button"
        id="structure-button"
        onclick="toggleModel('structure', this)"
      >
        Structure
      </button>
      <button
        class="toggle-button"
        id="tank-button"
        onclick="toggleModel('tank', this)"
      >
        Tank
      </button>
      <button
        class="toggle-button"
        id="control-box-button"
        onclick="toggleModel('control-box', this)"
      >
        Control Box
      </button>
      <button
        class="toggle-button"
        id="implode-all-button"
        onclick="implodeAll()"
      >
        Implode All
      </button>

      <!-- Background Scene æŒ‰é’®ç»„ -->
      <div class="button-title dynamic-color" id="backgroundSceneTitle">
        <strong>Background Scene</strong>
      </div>
      <button
        class="toggle-button"
        id="dayMode"
        onclick="setEnvironment('day')"
      >
        Day Mode
      </button>
      <button
        class="toggle-button"
        id="duskMode"
        onclick="setEnvironment('dusk')"
      >
        Dusk Mode
      </button>
      <button
        class="toggle-button"
        id="nightMode"
        onclick="setEnvironment('night')"
      >
        Night Mode
      </button>
      <button
        class="toggle-button"
        id="zenMode"
        onclick="setEnvironment('zen')"
      >
        Zen Mode
      </button>
      <!-- Color Customization æ§åˆ¶ -->
      <div class="button-title dynamic-color" id="colorTitle">
        <strong>Color Customization</strong>
      </div>
      <div style="display: flex; flex-direction: column; gap: 8px; margin: 10px 0;">
        <div style="display: flex; align-items: center; gap: 10px;">
          <label style="font-size: 10px; color: #666; min-width: 60px;">Tank:</label>
          <input type="color" id="tank-color" value="#00aa00" style="width: 40px; height: 25px; border: none; border-radius: 3px; cursor: pointer;">
        </div>
        <div style="display: flex; align-items: center; gap: 10px;">
          <label style="font-size: 10px; color: #666; min-width: 60px;">Metal:</label>
          <input type="color" id="metal-color" value="#c0c0c0" style="width: 40px; height: 25px; border: none; border-radius: 3px; cursor: pointer;">
        </div>
        <button class="toggle-button" id="apply-colors" onclick="applyCustomColors()" style="padding: 4px 8px; font-size: 10px; margin-top: 5px;">
          Apply Colors
        </button>
      </div>

      <!-- Rotation æ§åˆ¶ -->
      <div class="button-title dynamic-color" id="rotationTitle">
        <strong>Rotation</strong>
      </div>
      <div id="controls">
        <label for="rotation-speed" id="rotateSpeedControllerLabel">
          Rotate Speed Controller:&nbsp;&nbsp;&nbsp;
        </label>
        <input type="range" id="rotation-speed" min="1" max="100" value="20" />
      </div>

      <button
        class="toggle-button"
        id="toggleModelRotation"
        onclick="toggleModelRotation()"
      >
        Toggle Model Rotation
      </button>
      <button class="toggle-button" id="resetViewButton" onclick="resetView()">
        Reset View
      </button>
      <button
        class="toggle-button"
        id="languageToggleButton"
        onclick="toggleLanguage()"
      >
        English Mode
      </button>

      <div class="info-text" id="infoText">
        <div style="background: rgba(0,0,0,0.7); padding: 12px; border-radius: 8px; backdrop-filter: blur(10px);">
          <strong style="display: block; margin-bottom: 8px; font-size: 14px;">ğŸ® Controls</strong>
          <p style="margin: 4px 0; font-size: 12px;">ğŸ–±ï¸ Drag: Rotate view</p>
          <p style="margin: 4px 0; font-size: 12px;">ğŸ” Scroll: Zoom in/out</p>
          <p style="margin: 4px 0; font-size: 12px;">âŒ¨ï¸ Right click + drag: Pan</p>
          <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.2);">
            <p style="margin: 2px 0; font-size: 11px; opacity: 0.8;">ğŸ’¡ Try different lighting modes!</p>
          </div>
        </div>
      </div>

      <button class="toggle-button" id="zoom-button"></button>
    </div>

      <div class="copyright-text">
        Â© 2023 Andgreen Co. Ltd. All rights reserved.
      </div>
    </div>

    <a-scene
      renderer="colorManagement: true; shadowMapEnabled: true; shadowMapType: PCFSoft;"
      cursor="rayOrigin: mouse"
      raycaster="objects: [cube]"
      fog="color: #000000; near: 1; far: 110; oneMapping: ACESFilmicToneMapping"
    >
      <a-entity id="environment"></a-entity>
      <a-assets>
        <a-asset-item
          id="structure-model"
          src="3D/structure-model.gltf"
        ></a-asset-item>
        <a-asset-item id="tank-model" src="3D/tank-model.gltf"></a-asset-item>
        <a-asset-item
          id="control-box-model"
          src="3D/control-box-model.gltf"
        ></a-asset-item>
      </a-assets>

      <a-entity id="model-group" animate-model-group-on-load>
        <a-entity
          id="structure"
          gltf-model="#structure-model"
          metal-material
        ></a-entity>

        <a-entity
          id="tank"
          gltf-model="#tank-model"
          green-glass-material
        ></a-entity>
        <a-entity
          id="control-box"
          gltf-model="#control-box-model"
          metal-material
        ></a-entity>
      </a-entity>

      <a-light
        type="directional"
        color="#fff"
        intensity="2"
        position="5 8 5"
        cast-shadow="true"
        shadow-camera-near="1"
        shadow-camera-far="20"
        shadow-camera-left="-8"
        shadow-camera-right="8"
        shadow-camera-top="8"
        shadow-camera-bottom="-8"
        shadow-mapSize-width="2048"
        shadow-mapSize-height="2048"
        shadow-radius="2"
      ></a-light>
      <!--       <a-box position="0 0 0 " rotation="0 0 0" color="#4CC3D9"></a-box> -->
      <a-light type="ambient" color="#fff" intensity="0.3"></a-light>
      <a-light
        type="point"
        color="#fff"
        intensity="1.5"
        position="-3 4 3"
        cast-shadow="true"
      ></a-light>
      <a-sky :color="skyColor"></a-sky>

      <!-- <a-entity environment="preset: forest; dressingAmount: 800"></a-entity> -->
      <!-- <a-entity
      environment="preset: forest; dressingAmount: 150; dressingColor: #006400; dressingScale: 2; dressingVariance: {x: 5, y: 15, z: 8}; skyType: gradient; horizonColor: #C0C0C0; skyColor: #FFA700;"
    ></a-entity> -->
      <a-camera
        id="main-camera"
        position="0 1 3"
        look-controls="enabled: true; reverseMouseDrag: false; pointerLockEnabled: false;"
        wasd-controls="enabled: false;"
        orbit-controls="
          target: 0 0 0;
          enableDamping: true;
          dampingFactor: 0.1;
          autoRotate: false;
          enableZoom: true;
          enablePan: true;
          minDistance: 1;
          maxDistance: 10;
          minPolarAngle: 0;
          maxPolarAngle: 1.57;
        "
      ></a-camera>
    </a-scene>

    <script>
      // è¨»å†ŠGSAPæ’ä»¶
      gsap.registerPlugin(ScrollTrigger, TextPlugin);
      
      // è·³éè¼‰å…¥åŠŸèƒ½
      function skipLoading() {
        const loadingOverlay = document.getElementById('loading-overlay');
        gsap.to(loadingOverlay, {
          duration: 0.5,
          opacity: 0,
          onComplete: () => {
            loadingOverlay.style.display = 'none';
            showWelcomeGuide();
            initGSAPAnimations();
          }
        });
      }
      
      // GSAP å‹•ç•«åˆå§‹åŒ–
      function initGSAPAnimations() {
        // æ‡‰ç”¨3Dæ–‡å­—æ•ˆæœ
        document.querySelectorAll('.button-title').forEach(el => {
          create3DTextEffect(el);
        });
        
        // æŒ‰éˆ•é€²å…¥å‹•ç•«
        gsap.from(".toggle-button", {
          duration: 0.8,
          y: 30,
          opacity: 0,
          stagger: 0.1,
          ease: "power3.out",
          delay: 1
        });
        
        // æ¨™é¡Œå‹•ç•«
        gsap.from(".button-title", {
          duration: 1,
          x: -30,
          opacity: 0,
          stagger: 0.2,
          ease: "power2.out",
          delay: 0.5
        });
        
        // æ§åˆ¶é¢æ¿å‹•ç•«
        gsap.from("#controls", {
          duration: 1.2,
          scale: 0.8,
          opacity: 0,
          ease: "elastic.out(1, 0.5)",
          delay: 1.5
        });
        
        // ç‰ˆæ¬Šæ–‡å­—æ‰“å­—æ©Ÿæ•ˆæœ
        const copyrightEl = document.querySelector('.copyright-text');
        if (copyrightEl) {
          const copyrightText = copyrightEl.textContent;
          copyrightEl.textContent = '';
          gsap.to('.copyright-text', {
            duration: 2,
            text: copyrightText,
            ease: "none",
            delay: 2
          });
        }
        
        // æ‡¸æµ®å‹•ç•«
        document.querySelectorAll('.toggle-button').forEach(button => {
          button.addEventListener('mouseenter', function() {
            gsap.to(this, {
              duration: 0.3,
              scale: 1.05,
              ease: "power2.out"
            });
          });
          
          button.addEventListener('mouseleave', function() {
            gsap.to(this, {
              duration: 0.3,
              scale: 1,
              ease: "power2.out"
            });
          });
        });
        
        // æ§åˆ¶é¢æ¿è„ˆå‹•æ•ˆæœ
        gsap.to("#controls", {
          duration: 2,
          boxShadow: "0px 4px 20px rgba(0, 150, 255, 0.3)",
          repeat: -1,
          yoyo: true,
          ease: "sine.inOut"
        });
      }
      
      // 3Dæ–‡å­—æ•ˆæœ
      function create3DTextEffect(element) {
        element.style.textShadow = `
          1px 1px 0 rgba(0,0,0,0.1),
          2px 2px 0 rgba(0,0,0,0.08),
          3px 3px 0 rgba(0,0,0,0.06),
          4px 4px 0 rgba(0,0,0,0.04),
          5px 5px 10px rgba(0,0,0,0.2)
        `;
      }
      
      // è¼‰å…¥é€²åº¦ç®¡ç†
      document.addEventListener('DOMContentLoaded', function() {
        const loadingOverlay = document.getElementById('loading-overlay');
        const progressBar = document.getElementById('progress-bar');
        const loadingStatus = document.getElementById('loading-status');
        
        let loadedAssets = 0;
        const totalAssets = 3; // 3å€‹GLTFæ¨¡å‹
        
        // æª¢æŸ¥æ˜¯å¦åœ¨æœ¬åœ°æª”æ¡ˆç³»çµ±
        if (window.location.protocol === 'file:') {
          console.warn('æª¢æ¸¬åˆ°æœ¬åœ°æª”æ¡ˆç³»çµ±ï¼Œå¯èƒ½ç„¡æ³•è¼‰å…¥3Dæ¨¡å‹');
          loadingStatus.textContent = 'è«‹ä½¿ç”¨HTTPä¼ºæœå™¨æˆ–è¨ªå•ç·šä¸Šç‰ˆæœ¬';
        }
        
        // ç›£è½å ´æ™¯è¼‰å…¥å®Œæˆ
        document.querySelector('a-scene').addEventListener('loaded', function() {
          setTimeout(() => {
            progressBar.style.width = '100%';
            loadingStatus.textContent = 'è¼‰å…¥å®Œæˆï¼';
            
            setTimeout(() => {
              loadingOverlay.style.opacity = '0';
              loadingOverlay.style.transition = 'opacity 0.5s ease';
              setTimeout(() => {
                loadingOverlay.style.display = 'none';
                // é¡¯ç¤ºæ­¡è¿æç¤º
                showWelcomeGuide();
                // åˆå§‹åŒ–GSAPå‹•ç•«
                initGSAPAnimations();
              }, 500);
            }, 800);
          }, 1000);
        });

        // æ­¡è¿æŒ‡å¼•
        function showWelcomeGuide() {
          if (localStorage.getItem('algaetank-welcome-shown')) return;
          
          setTimeout(() => {
            showNotification('ğŸ‰ æ­¡è¿ï¼æŒ‰ H éµæŸ¥çœ‹å¿«æ·éµèªªæ˜', 'info');
            localStorage.setItem('algaetank-welcome-shown', 'true');
          }, 1500);
        }

        // ç›£è½è³‡ç”¢è¼‰å…¥é€²åº¦
        document.querySelectorAll('a-asset-item').forEach((asset, index) => {
          asset.addEventListener('loaded', () => {
            loadedAssets++;
            const progress = Math.floor((loadedAssets / totalAssets) * 80); // 80% for assets, 20% for setup
            progressBar.style.width = progress + '%';
            loadingStatus.textContent = `è¼‰å…¥æ¨¡å‹ ${loadedAssets}/${totalAssets}...`;
          });
          
          // éŒ¯èª¤è™•ç†
          asset.addEventListener('error', (e) => {
            console.error('è³‡æºè¼‰å…¥éŒ¯èª¤:', asset.id, e);
            loadedAssets++;
            const progress = Math.floor((loadedAssets / totalAssets) * 80);
            progressBar.style.width = progress + '%';
            loadingStatus.textContent = `è¼‰å…¥éŒ¯èª¤ï¼Œå˜—è©¦ç¹¼çºŒ...`;
          });
        });
        
        // 3ç§’å¾Œé¡¯ç¤ºè·³éæŒ‰éˆ•
        setTimeout(() => {
          const skipButton = document.getElementById('skip-loading');
          if (skipButton && loadingOverlay.style.display !== 'none') {
            skipButton.style.display = 'block';
            gsap.from(skipButton, {
              duration: 0.5,
              opacity: 0,
              y: 20,
              ease: "power2.out"
            });
          }
        }, 3000);
        
        // è¶…æ™‚è™•ç†
        setTimeout(() => {
          if (loadingOverlay.style.display !== 'none') {
            console.warn('è¼‰å…¥è¶…æ™‚ï¼Œå¼·åˆ¶é€²å…¥');
            skipLoading();
          }
        }, 10000); // 10ç§’è¶…æ™‚
      });

      // é¡è‰²è‡ªè¨‚åŠŸèƒ½
      function applyCustomColors() {
        const tankColor = document.getElementById('tank-color').value;
        const metalColor = document.getElementById('metal-color').value;
        
        // å‰µå»ºé¡è‰²é è¦½æ•ˆæœ
        const colorPreview = document.createElement('div');
        colorPreview.style.cssText = `
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%) scale(0);
          width: 200px;
          height: 200px;
          border-radius: 50%;
          background: conic-gradient(${tankColor} 0deg 180deg, ${metalColor} 180deg 360deg);
          z-index: 10000;
          box-shadow: 0 0 50px rgba(0,0,0,0.3);
        `;
        document.body.appendChild(colorPreview);
        
        // é è¦½å‹•ç•«
        gsap.to(colorPreview, {
          duration: 0.5,
          scale: 1,
          rotation: 360,
          ease: "back.out(1.7)"
        });
        
        // æ›´æ–°ç¶ è—»ç¼¸é¡è‰²
        const tankEl = document.querySelector('#tank');
        if (tankEl && tankEl.getObject3D('mesh')) {
          tankEl.getObject3D('mesh').traverse(function(node) {
            if (node.isMesh) {
              // ä½¿ç”¨GSAPå‹•ç•«éæ¸¡é¡è‰²
              const currentColor = node.material.color.getHex();
              const targetColor = parseInt(tankColor.replace('#', '0x'));
              
              gsap.to(node.material.color, {
                duration: 1,
                r: ((targetColor >> 16) & 255) / 255,
                g: ((targetColor >> 8) & 255) / 255,
                b: (targetColor & 255) / 255,
                ease: "power2.inOut"
              });
            }
          });
        }
        
        // æ›´æ–°é‡‘å±¬éƒ¨ä»¶é¡è‰²
        ['#structure', '#control-box'].forEach(selector => {
          const el = document.querySelector(selector);
          if (el && el.getObject3D('mesh')) {
            el.getObject3D('mesh').traverse(function(node) {
              if (node.isMesh) {
                const targetColor = parseInt(metalColor.replace('#', '0x'));
                
                gsap.to(node.material.color, {
                  duration: 1,
                  r: ((targetColor >> 16) & 255) / 255,
                  g: ((targetColor >> 8) & 255) / 255,
                  b: (targetColor & 255) / 255,
                  ease: "power2.inOut"
                });
              }
            });
          }
        });
        
        // ç§»é™¤é è¦½
        gsap.to(colorPreview, {
          duration: 0.5,
          scale: 0,
          rotation: -360,
          opacity: 0,
          delay: 1,
          ease: "back.in(1.7)",
          onComplete: () => {
            document.body.removeChild(colorPreview);
          }
        });
        
        // æŒ‰éˆ•å‹•ç•«
        const applyButton = document.getElementById('apply-colors');
        gsap.to(applyButton, {
          duration: 0.2,
          scale: 0.95,
          yoyo: true,
          repeat: 1,
          ease: "power2.inOut"
        });
        
        // é¡¯ç¤ºæˆåŠŸæç¤º
        showNotification('âœ¨ é¡è‰²å·²æ›´æ–°ï¼', 'success');
      }

      // å¿«æ·éµæ”¯æ´
      document.addEventListener('keydown', function(event) {
        // é˜²æ­¢åœ¨è¼¸å…¥æ¡†ä¸­è§¸ç™¼
        if (event.target.tagName === 'INPUT') return;
        
        switch(event.key.toLowerCase()) {
          case '1':
            setEnvironment('day');
            showNotification('â˜€ï¸ åˆ‡æ›åˆ°æ—¥é–“æ¨¡å¼', 'info');
            break;
          case '2':
            setEnvironment('dusk');
            showNotification('ğŸŒ… åˆ‡æ›åˆ°é»ƒæ˜æ¨¡å¼', 'info');
            break;
          case '3':
            setEnvironment('night');
            showNotification('ğŸŒ™ åˆ‡æ›åˆ°å¤œé–“æ¨¡å¼', 'info');
            break;
          case '4':
            setEnvironment('zen');
            showNotification('ğŸ§˜ åˆ‡æ›åˆ°ç¦ªæ¨¡å¼', 'info');
            break;
          case 'r':
            resetView();
            showNotification('ğŸ”„ è¦–è§’å·²é‡ç½®', 'info');
            break;
          case 'e':
            implodeAll();
            showNotification('ğŸ“¦ æ¨¡å‹å·²é‡çµ„', 'info');
            break;
          case 'h':
            toggleHelpPanel();
            break;
        }
      });

      // èªªæ˜é¢æ¿åˆ‡æ›
      function toggleHelpPanel() {
        const helpPanel = document.getElementById('help-panel') || createHelpPanel();
        helpPanel.style.display = helpPanel.style.display === 'none' ? 'block' : 'none';
      }

      function createHelpPanel() {
        const panel = document.createElement('div');
        panel.id = 'help-panel';
        panel.style.cssText = `
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: rgba(0,0,0,0.9);
          color: white;
          padding: 30px;
          border-radius: 12px;
          z-index: 10001;
          max-width: 400px;
          backdrop-filter: blur(10px);
          border: 1px solid rgba(255,255,255,0.1);
        `;
        
        panel.innerHTML = `
          <div style="text-align: center;">
            <h3 style="margin-top: 0; color: #00ff88;">ğŸ® å¿«æ·éµèªªæ˜</h3>
            <div style="text-align: left; line-height: 1.6;">
              <p><strong>1-4</strong>: åˆ‡æ›å…‰ç…§æ¨¡å¼</p>
              <p><strong>R</strong>: é‡ç½®è¦–è§’</p>
              <p><strong>E</strong>: é‡çµ„æ¨¡å‹</p>
              <p><strong>H</strong>: é¡¯ç¤º/éš±è—æ­¤èªªæ˜</p>
            </div>
            <button onclick="toggleHelpPanel()" style="
              margin-top: 20px;
              padding: 8px 16px;
              background: #00ff88;
              color: black;
              border: none;
              border-radius: 6px;
              cursor: pointer;
              font-weight: bold;
            ">é—œé–‰</button>
          </div>
        `;
        
        document.body.appendChild(panel);
        return panel;
      }

      // é€šçŸ¥ç³»çµ±
      function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = 'notification-toast';
        
        const gradient = type === 'success' 
          ? 'linear-gradient(135deg, #00ff88 0%, #00d4ff 100%)'
          : 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
        
        notification.style.cssText = `
          position: fixed;
          top: 20px;
          right: -400px;
          background: ${gradient};
          color: white;
          padding: 16px 24px;
          border-radius: 12px;
          box-shadow: 0 10px 40px rgba(0,0,0,0.2);
          z-index: 10000;
          font-size: 14px;
          font-weight: 500;
          display: flex;
          align-items: center;
          gap: 12px;
          backdrop-filter: blur(10px);
          border: 1px solid rgba(255,255,255,0.2);
          max-width: 350px;
        `;
        
        // æ·»åŠ åœ–æ¨™
        const icon = document.createElement('span');
        icon.style.fontSize = '20px';
        icon.textContent = type === 'success' ? 'âœ¨' : 'ğŸ’«';
        notification.appendChild(icon);
        
        // æ·»åŠ æ¶ˆæ¯æ–‡æœ¬
        const text = document.createElement('span');
        text.textContent = message;
        notification.appendChild(text);
        
        document.body.appendChild(notification);
        
        // GSAP å‹•ç•«é€²å…¥
        gsap.to(notification, {
          duration: 0.6,
          right: 20,
          ease: "elastic.out(1, 0.8)"
        });
        
        // å¾®å¦™çš„æ–æ“ºå‹•ç•«
        gsap.to(notification, {
          duration: 0.3,
          rotation: 2,
          repeat: 1,
          yoyo: true,
          delay: 0.6,
          ease: "power2.inOut"
        });
        
        // è‡ªå‹•ç§»é™¤
        setTimeout(() => {
          gsap.to(notification, {
            duration: 0.4,
            right: -400,
            opacity: 0,
            scale: 0.8,
            ease: "power2.in",
            onComplete: () => {
              if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
              }
            }
          });
        }, 3500);
      }

      var modelStates = {
        structure: { expanded: false, position: { x: 0, y: 0, z: 0 } },
        tank: { expanded: false, position: { x: 0, y: 0, z: 0 } },
        "control-box": { expanded: false, position: { x: 0, y: 0, z: 0 } }
      };
      var initialCameraPosition, initialCameraRotation, initialModelPositions;
      var camera, modelGroup;
      var modelRotationActive = false,
        modelRotationTween;
      var rotationSpeedControl = document.getElementById("rotation-speed");
      rotationSpeedControl.disabled = true;
      var initialGroupCenter;
      var initialState = {
        position: { x: 0, y: 0, z: 2 }, // Replace with actual initial values
        rotation: { x: 0, y: 0, z: 0 } // Replace with actual initial values
      };
      var zoomState = {
        position: { x: -0.4, y: 0, z: 0.2 }, // Replace with actual zoom values
        rotation: { x: 0, y: 0, z: 0 } // Replace with actual zoom values
      };
      var initialCameraState = {
        position: { x: 0, y: 1, z: 5 },
        rotation: { x: 0, y: 0, z: 0 },
        target: { x: 0, y: 0, z: 0 }
      };

      var zoomCameraState = {
        position: { x: -0.4, y: 1, z: 2 },
        rotation: { x: 0, y: Math.PI / 2, z: 0 }, // Adjust as needed
        target: { x: -0.4, y: 0, z: 0.2 }
      };

      document.querySelector("a-scene").addEventListener("loaded", function () {
        camera = document.querySelector("#main-camera").getObject3D("camera");
        modelGroup = document.querySelector("#model-group");
        modelGroup.addEventListener("model-loaded", setupScene);
        // Save the initial state
        initialCameraPosition = camera.position.clone();
        initialCameraRotation = camera.rotation.clone();
        initialCameraState = {
          position: initialCameraPosition.clone(),
          rotation: initialCameraRotation.clone(),
          target: new THREE.Vector3(0, 1, 0) // Assuming looking at origin
        };
        // Rest of your code...
      });

      function moveModelGroupToOrigin() {
        var bbox = new THREE.Box3().setFromObject(modelGroup.object3D);
        var bboxBottomCenter = new THREE.Vector3(
          bbox.min.x + (bbox.max.x - bbox.min.x) / 2,
          bbox.min.y,
          bbox.min.z + (bbox.max.z - bbox.min.z) / 2
        );

        modelGroup.object3D.position.set(
          -bboxBottomCenter.x,
          -bboxBottomCenter.y,
          -bboxBottomCenter.z
        );
      }
      function setupScene() {
        moveModelGroupToOrigin();
        adjustModelPositionAndCamera();
        setInitialStates();
        calculateInitialGroupCenter(); // è¨ˆç®—æ¨¡å‹ç¾¤çµ„çš„åˆå§‹ä¸­å¿ƒé»
      }

      function resetCameraView() {
        // Set camera to its initial position
        camera.position.set(
          initialState.position.x,
          initialState.position.y + 1,
          initialState.position.z - 2
        );
        // Reset camera's rotation

        camera.lookAt(new THREE.Vector3(0, 1, 0)); // Adjust t
        // Alternatively, reset the rotation using quaternions

        /*     camera.quaternion.setFromEuler(
               new THREE.Euler(
                 initialState.rotation.x,
                 initialState.rotation.y,
                 initialState.rotation.z,
                 "YXZ" // this may vary depending on how your camera is set up

             );
         */
        // Ensure the camera is looking at the desired point
      }

      function updateCamera(state) {
        camera.position.set(
          state.position.x,
          state.position.y,
          state.position.z
        );
        camera.rotation.set(
          state.rotation.x,
          state.rotation.y,
          state.rotation.z
        );
        camera.lookAt(
          new THREE.Vector3(state.target.x, state.target.y, state.target.z)
        );
      }

      function resetView() {
        stopModelRotation(); // Stop model rotation
        camera.position.copy(initialCameraPosition); // Reset camera position to its initial state
        camera.rotation.copy(initialCameraRotation); // Reset camera rotation to its initial state
        // Look at the initial center of the model group
        camera.lookAt(
          new THREE.Vector3(
            initialCameraState.target.x,
            initialCameraState.target.y,
            initialCameraState.target.z
          )
        );

        // Move each model back to its initial position
        Object.keys(initialModelPositions).forEach(function (key) {
          var model = document.querySelector("#" + key);
          var initialPos = initialModelPositions[key];

          gsap.to(model.object3D.position, {
            duration: 1,
            x: initialPos.x,
            y: initialPos.y,
            z: initialPos.z,
            ease: "power3.inOut"
          });
        });

        // Reset the model group's rotation
        gsap.to(modelGroup.object3D.rotation, {
          duration: 1,
          x: 0,
          y: 0,
          z: 0,
          ease: "power3.inOut"
        });

        implodeAll();
      }
      function zoomInModel() {
        updateCamera(zoomCameraState);
        resetView(); // Ensuring the camera starts from the initial position
        // Set the camera to the specific zoom state
        camera.position.set(-1, 1, -2);
        camera.rotation.set(0, 0, 0); // Adjust as needed
        camera.lookAt(new THREE.Vector3(0, 1, 0)); // Adjust the vector to your desired lookAt point for the zoom
      }
      // Bind the zoomInModel function to the click event of the zoom-button
      document
        .getElementById("zoom-button")
        .addEventListener("click", zoomInModel);
      document
        .getElementById("resetViewButton")
        .addEventListener("click", resetView);

      document
        .getElementById("zoom-button")
        .addEventListener("click", function () {
          // ... set camera position and rotation ...
        });

      document
        .getElementById("resetViewButton")
        .addEventListener("click", function () {
          // ... reset camera position and rotation ...
        });

      /*  function adjustModelPositionAndCamera() {
                   var bbox = new THREE.Box3().setFromObject(modelGroup.object3D);
                   var bboxCenter = bbox.getCenter(new THREE.Vector3());
                   var cameraDistance = bbox.getSize(new THREE.Vector3()).length();

                   camera.position.set(
                     bboxCenter.x,
                     bboxCenter.y,
                     bboxCenter.z + cameraDistance / 2
                   );
                   camera.lookAt(bboxCenter);
                 }
               */

      function adjustModelPositionAndCamera() {
        var bbox = new THREE.Box3().setFromObject(modelGroup.object3D);
        var bboxCenter = bbox.getCenter(new THREE.Vector3());
        var cameraDistance = bbox.getSize(new THREE.Vector3()).length();

        // è®¾ç½®æ‘„åƒæœºçš„ä½ç½®ï¼Œç¡®ä¿ y åæ ‡ä¸º 2
        camera.position.set(
          0, //bboxCenter.x,
          1, // è®¾ç½® y åæ ‡ä¸º 2
          0 //bboxCenter.z + cameraDistance / 2 - 1
        );
        camera.lookAt(new THREE.Vector3(0, 1, 0));
        //camera.lookAt(new THREE.Vector3(0, 1, 0));
      }

      function setInitialStates() {
        initialCameraPosition = camera.position.clone();
        initialCameraRotation = camera.rotation.clone();
        initialModelPositions = {};
        Object.keys(modelStates).forEach(function (key) {
          var model = document.querySelector("#" + key);
          initialModelPositions[key] = model.getAttribute("position");
        });
      }

      // å…¶ä»–ä»£ç ä¿æŒä¸å˜

      function toggleModel(modelId, button) {
        var model = document.querySelector("#" + modelId);
        var bbox = new THREE.Box3().setFromObject(model.object3D);
        var size = bbox.getSize(new THREE.Vector3());

        if (modelStates[modelId].expanded) {
          // æ”¶å›å‹•ç•«
          gsap.to(model.object3D.position, {
            duration: 1.2,
            x: 0,
            y: 0,
            z: 0,
            ease: "back.inOut(1.7)"
          });
          
          // æ—‹è½‰å¾©ä½
          gsap.to(model.object3D.rotation, {
            duration: 1.2,
            x: 0,
            y: 0,
            z: 0,
            ease: "power2.inOut"
          });
          
          button.classList.remove("active");
          
          // éœ‡å‹•æ•ˆæœ
          gsap.to(model.object3D.scale, {
            duration: 0.2,
            x: 1.1,
            y: 1.1,
            z: 1.1,
            repeat: 1,
            yoyo: true,
            ease: "power2.inOut"
          });
        } else {
          var pos = { x: 0, y: 0, z: 0 };
          var rot = { x: 0, y: 0, z: 0 };
          
          switch (modelId) {
            case "structure":
              pos.x = size.x * -2.5;
              rot.y = -0.3;
              break;
            case "tank":
              pos.y = size.y * 3.5;
              rot.x = 0.2;
              break;
            case "control-box":
              pos.x = size.x * 2.5;
              rot.y = 0.3;
              break;
          }
          
          // çˆ†ç‚¸å‹•ç•«æ™‚é–“è»¸
          const tl = gsap.timeline();
          
          // å…ˆç¸®æ”¾
          tl.to(model.object3D.scale, {
            duration: 0.2,
            x: 0.9,
            y: 0.9,
            z: 0.9,
            ease: "power2.in"
          })
          // ç„¶å¾Œçˆ†ç‚¸ç§»å‹•
          .to(model.object3D.position, {
            duration: 1,
            x: pos.x,
            y: pos.y,
            z: pos.z,
            ease: "expo.out"
          }, "-=0.1")
          // åŒæ™‚æ—‹è½‰
          .to(model.object3D.rotation, {
            duration: 1,
            x: rot.x,
            y: rot.y,
            z: rot.z,
            ease: "power2.out"
          }, "<")
          // æœ€å¾Œå›å½ˆ
          .to(model.object3D.scale, {
            duration: 0.3,
            x: 1,
            y: 1,
            z: 1,
            ease: "elastic.out(1, 0.5)"
          });
          
          button.classList.add("active");
          
          // ç™¼å…‰æ•ˆæœ
          gsap.to(button, {
            duration: 0.3,
            boxShadow: "0 0 20px rgba(0, 255, 136, 0.5)",
            repeat: 1,
            yoyo: true
          });
        }

        modelStates[modelId].expanded = !modelStates[modelId].expanded;
      }

      // å…¶ä»–ä»£ç ä¿æŒä¸å˜

      AFRAME.registerComponent("animate-model-group-on-load", {
        init: function () {
          var el = this.el; // è·å–å½“å‰å…ƒç´ ï¼ˆmodel-groupï¼‰
          var initialYPosition = 0; // å‡è®¾åœ°å¹³é¢çš„ä½ç½®æ˜¯0

          // è®¾ç½®ä¸€ä¸ªæ ‡å¿—ï¼Œç¡®ä¿åŠ¨ç”»åªæ‰§è¡Œä¸€æ¬¡
          var animationExecuted = false;

          // ç›‘å¬æ‰€æœ‰å­æ¨¡å‹çš„ model-loaded äº‹ä»¶
          el.addEventListener("model-loaded", () => {
            if (!animationExecuted) {
              animationExecuted = true; // è®¾ç½®æ ‡å¿—ä»¥é¿å…é‡å¤åŠ¨ç”»

              // æ¨¡å‹åŠ è½½å®Œæˆåæ‰§è¡Œçš„ä»£ç 
              gsap.fromTo(
                el.object3D.position,
                { y: 2 }, // åŠ¨ç”»å¼€å§‹ä½ç½®ï¼ˆåœ°å¹³é¢ä»¥ä¸ŠæŸä¸ªä½ç½®ï¼‰
                {
                  y: initialYPosition, // åŠ¨ç”»ç»“æŸä½ç½®ï¼ˆåœ°å¹³é¢ä½ç½®ï¼‰
                  duration: 1.5, // æŒç»­æ—¶é—´
                  ease: "bounce.out", // ç¼“åŠ¨æ•ˆæœ
                  onComplete: () =>
                    console.log(`Animation completed for model group`)
                }
              );
            }
          });
        }
      });
      function implodeAll() {
        Object.keys(modelStates).forEach(function (modelId) {
          var model = document.querySelector("#" + modelId);
          gsap.to(model.object3D.position, {
            duration: 1,
            x: 0,
            y: 0,
            z: 0,
            ease: "power3.inOut"
          });
          modelStates[modelId].expanded = false;
        });
        document
          .querySelectorAll(".toggle-button")
          .forEach((button) => button.classList.remove("active"));
      }

      function calculateInitialGroupCenter() {
        var bbox = new THREE.Box3().setFromObject(modelGroup.object3D);
        initialGroupCenter = bbox.getCenter(new THREE.Vector3());
        rotationCenter = new THREE.Vector3(0, initialGroupCenter.y, 0);
      }

      function toggleModelRotation() {
        modelRotationActive = !modelRotationActive;
        rotationSpeedControl.disabled = !modelRotationActive;

        if (modelRotationActive) {
          startModelRotation();
        } else {
          stopModelRotation();
        }
      }
      function startModelRotation() {
        if (modelRotationTween) {
          modelRotationTween.kill();
        }

        // è®¡ç®—æ¨¡å‹ç¾¤çš„ä¸­å¿ƒç‚¹
        var bbox = new THREE.Box3().setFromObject(modelGroup.object3D);
        var center = bbox.getCenter(new THREE.Vector3());
        var radiusMultiplier = 0.04;
        // ä¿®æ”¹æ—‹è½¬æŒç»­æ—¶é—´ä»¥æ§åˆ¶é€Ÿåº¦ï¼Œè€ƒè™‘äº† radiusMultiplier çš„å½±å“
        var rotationDuration =
          360 / (rotationSpeedControl.value * radiusMultiplier);

        modelRotationTween = gsap.to(modelGroup.object3D.rotation, {
          duration: rotationDuration,
          y: "+=360",
          ease: "smooth",
          repeat: -1,
          onUpdate: function () {
            // åœ¨æ¯æ¬¡æ›´æ–°æ—¶é‡æ–°è®¡ç®—æ¨¡å‹ç¾¤çš„ä¸­å¿ƒç‚¹
            modelGroup.object3D.updateMatrixWorld();
            modelGroup.object3D.matrixWorld.decompose(
              center,
              new THREE.Quaternion(),
              new THREE.Vector3()
            );
            modelGroup.object3D.updateMatrix();
            modelGroup.object3D.updateWorldMatrix();
          },
          transformOrigin: "center center"
        });
      }

      function stopModelRotation() {
        if (modelRotationTween) {
          modelRotationTween.kill();
        }
        modelRotationActive = false;
        rotationSpeedControl.disabled = true;
      }

      rotationSpeedControl.addEventListener("input", function () {
        if (modelRotationActive) {
          startModelRotation();
        }
      });

      window.addEventListener("keydown", function (event) {
        if (event.key === "Shift") {
          isShiftDown = true;
        }
      });

      window.addEventListener("keyup", function (event) {
        if (event.key === "Shift") {
          isShiftDown = false;
        }
      });

      window.addEventListener("mousedown", function (event) {
        if (isShiftDown) {
          lastMouseX = event.clientX;
          lastMouseY = event.clientY;
        }
      });

      window.addEventListener("mousemove", function (event) {
        if (
          isShiftDown &&
          lastMouseX !== undefined &&
          lastMouseY !== undefined
        ) {
          let deltaX = event.clientX - lastMouseX;
          let deltaY = event.clientY - lastMouseY;
          camera.position.x -= deltaX * 0.01;
          camera.position.y += deltaY * 0.01;
          lastMouseX = event.clientX;
          lastMouseY = event.clientY;
        }
      });

      window.addEventListener("mouseup", function () {
        lastMouseX = undefined;
        lastMouseY = undefined;
      });
      window.addEventListener("wheel", function (event) {
        var delta = -event.wheelDelta || event.detail;
        var newZ = camera.position.z + delta * 0.0005;
        camera.position.z = newZ;
        event.preventDefault();
      });
      AFRAME.registerComponent("material-color", {
        schema: { type: "color" },

        update: function () {
          var color = new THREE.Color(this.data);
          var el = this.el;

          el.addEventListener("model-loaded", function () {
            var mesh = el.getObject3D("mesh");
            if (!mesh) return;

            mesh.traverse(function (node) {
              if (node.isMesh && node.material) {
                node.material.color.set(color);
              }
            });
          });
        }
      });

      AFRAME.registerComponent("green-glass-material", {
        init: function () {
          var el = this.el;

          el.addEventListener("model-loaded", function () {
            var mesh = el.getObject3D("mesh");
            if (!mesh) return;

            mesh.traverse(function (node) {
              if (node.isMesh) {
                node.material = new THREE.MeshStandardMaterial({
                  color: 0x00aa00, // æ·±ç¶ è‰²
                  metalness: 0.1,
                  roughness: 0.1,
                  transparent: true,
                  opacity: 0.7,
                  transmission: 0.9,
                  thickness: 0.5
                });
                node.castShadow = true;
                node.receiveShadow = true;
              }
            });
          });
        },
        updateMaterial: function (opts) {
          var mesh = this.el.getObject3D("mesh");
          if (!mesh) return;

          mesh.traverse(function (node) {
            if (node.isMesh) {
              node.material.emissiveIntensity = opts.emissiveIntensity;
            }
          });
        }
      });

      AFRAME.registerComponent("metal-material", {
        init: function () {
          var el = this.el;

          el.addEventListener("model-loaded", function () {
            var mesh = el.getObject3D("mesh");
            if (!mesh) return;

            mesh.traverse(function (node) {
              if (node.isMesh) {
                node.material = new THREE.MeshStandardMaterial({
                  color: 0xc0c0c0, // éŠ€è‰²
                  metalness: 0.9,
                  roughness: 0.2,
                  envMapIntensity: 1.0
                });
                node.castShadow = true;
                node.receiveShadow = true;
              }
            });
          });
        },
        updateMaterial: function (opts) {
          var mesh = this.el.getObject3D("mesh");
          if (!mesh) return;

          mesh.traverse(function (node) {
            if (node.isMesh) {
              node.material.emissiveIntensity = opts.emissiveIntensity;
            }
          });
        }
      });
      AFRAME.registerComponent("cool-material", {
        init: function () {
          var el = this.el;

          el.addEventListener("model-loaded", function () {
            var mesh = el.getObject3D("mesh");
            if (!mesh) return;

            mesh.traverse(function (node) {
              if (node.isMesh) {
                node.material = new THREE.MeshPhongMaterial({
                  color: 0x0066ff, // è—è‰²éœ“è™¹
                  emissive: 0x001155,
                  emissiveIntensity: 0.8,
                  shininess: 90,
                  transparent: true,
                  opacity: 0.9
                });
              }
            });
          });
        }
      });

      function setEnvironment(mode) {
        var environmentEl = document.getElementById("environment");
        var modelEl = document.querySelectorAll(
          "[green-glass-material], [metal-material]"
        );
        var dynamicColorEls = document.querySelectorAll(".dynamic-color");

        // å‰µå»ºè½‰å ´æ•ˆæœ
        const transitionOverlay = document.createElement('div');
        transitionOverlay.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: radial-gradient(circle at center, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.95) 100%);
          z-index: 9998;
          pointer-events: none;
          opacity: 0;
        `;
        document.body.appendChild(transitionOverlay);
        
        // ç§»é™¤è½‰å ´æ•ˆæœï¼Œé¿å…ç’°å¢ƒæ¶ˆå¤±
        transitionOverlay.remove();

        function setDynamicColor(color) {
          dynamicColorEls.forEach(function (el) {
            gsap.to(el, {
              duration: 0.5,
              color: color,
              ease: "power2.inOut"
            });
          });
        }

        switch (mode) {
          case "day":
            environmentEl.setAttribute(
              "environment",
              "preset: forest; dressingAmount: 0; skyType: gradient; horizonColor: #87CEEB; skyColor: #87CEEB; fog: 0.81; ground: flat; groundColor: #445; groundColor2: #333; groundTexture: checkerboard"
            );
            // ç¢ºä¿æ—¥é–“æ¨¡å¼æè³ªæ­£å¸¸é¡¯ç¤º
            modelEl.forEach((el) => {
              if (el.components["green-glass-material"]) {
                el.components["green-glass-material"].init();
              }
              if (el.components["metal-material"]) {
                el.components["metal-material"].init();
              }
            });
            setDynamicColor("#333");
            break;
          case "dusk":
            environmentEl.setAttribute(
              "environment",
              "preset: forest; dressingAmount: 0; skyType: gradient; horizonColor: #FFA501; skyColor: #FF3500; fog: 0.88; ground: flat; groundColor: #553; groundColor2: #331; groundTexture: checkerboard"
            );

            setDynamicColor("#333");
            break;
          case "night":
            skyColor = "#000";
            environmentEl.setAttribute(
              "environment",
              "preset: starry; skyType: atmosphere; fog: 0.1; grid: none; ground: flat; groundColor: #222; groundColor2: #111; groundTexture: checkerboard"
            );
            modelEl.forEach((el) => {
              if (!el.is("#structure") && !el.is("#control-box")) {
                el.components["green-glass-material"]?.updateMaterial({
                  emissiveIntensity: 5
                });
                el.components["metal-material"]?.updateMaterial({
                  emissiveIntensity: 4
                });
              }
            });
            applyCoolMaterial("#structure");
            applyCoolMaterial("#control-box");
            setDynamicColor("#fff");

            break;
          case "zen":
            environmentEl.setAttribute(
              "environment",
              "preset: starry; skyType: gradient; horizonColor: #000000; skyColor: #FFFFFF; ground: flat; groundColor: #888; groundColor2: #999; groundTexture: checkerboard; fog: 0.8"
            );
            document.querySelector("a-sky").setAttribute("color", "#FFFFFF");
            setDynamicColor("#ffffff");
            break;

          default:
            console.error("Unknown environment mode: " + mode);
            return;
        }
        document.querySelector("a-sky").setAttribute("color", skyColor);
      }

      function applyCoolMaterial(selector) {
        var el = document.querySelector(selector);
        if (el) {
          // ç­‰å¾…æ¨¡å‹åŠ è½½å®Œæˆ
          el.addEventListener("model-loaded", () => {
            changeToCoolMaterial(el);
          });
        }
      }

      function changeToCoolMaterial(el) {
        el.removeAttribute("metal-material");
        el.removeAttribute("green-glass-material");
        el.setAttribute("cool-material", "");
      }

      // åœ¨é¡µé¢åŠ è½½æ—¶é»˜è®¤ä¸ºç™½å¤©æ¨¡å¼
      setEnvironment("day");

      window.addEventListener("touchstart", function (event) {
        if (event.touches.length === 2) {
          pinchZoom.isPinching = true;
          pinchZoom.initialDistance = getDistanceBetweenTouches(event);
        }
      });

      window.addEventListener("touchmove", function (event) {
        if (pinchZoom.isPinching && event.touches.length === 2) {
          pinchZoom.currentDistance = getDistanceBetweenTouches(event);
          var zoomFactor =
            pinchZoom.currentDistance / pinchZoom.initialDistance;
          adjustCameraZoom(zoomFactor);
          pinchZoom.initialDistance = pinchZoom.currentDistance;
        }
      });

      window.addEventListener("touchend", function () {
        pinchZoom.isPinching = false;
        pinchZoom.initialDistance = null;
      });

      function getDistanceBetweenTouches(event) {
        var dx = event.touches[0].pageX - event.touches[1].pageX;
        var dy = event.touches[0].pageY - event.touches[1].pageY;
        return Math.sqrt(dx * dx + dy * dy);
      }

      function adjustCameraZoom(zoomFactor) {
        // æ ¹æ®ç¼©æ”¾å› å­è°ƒæ•´ç›¸æœºä½ç½®
        var newZ = camera.position.z * zoomFactor;
        camera.position.z = newZ;
      }

      // è°ƒæ•´é»˜è®¤ç›¸æœºä½ç½®
      function adjustDefaultCameraPosition() {
        camera.position.set(0, 0, 4); // è°ƒæ•´ä¸ºæ›´è¿‘çš„ä½ç½®
      }

      // è°ƒæ•´ Shift é”®å¹³ç§»åŠŸèƒ½
      window.addEventListener("keydown", function (event) {
        if (event.key === "Shift") {
          camera.controls.enablePan = true;
        }
      });

      window.addEventListener("keyup", function (event) {
        if (event.key === "Shift") {
          camera.controls.enablePan = false;
        }
      });

      function adjustInfoTextPosition() {
        var infoText = document.getElementById("infoText");
        if (isChineseMode) {
          // è°ƒæ•´ä¸ºé€‚åˆä¸­æ–‡çš„ä½ç½®
          infoText.style.right = "25px"; // ç¤ºä¾‹å€¼ï¼Œæ ¹æ®éœ€è¦è°ƒæ•´
          infoText.style.top = "15px"; // ç¤ºä¾‹å€¼ï¼Œæ ¹æ®éœ€è¦è°ƒæ•´
        } else {
          // è°ƒæ•´ä¸ºé€‚åˆè‹±æ–‡çš„ä½ç½®
          infoText.style.right = "10px"; // ç¤ºä¾‹å€¼ï¼Œæ ¹æ®éœ€è¦è°ƒæ•´
          infoText.style.top = "15px"; // ç¤ºä¾‹å€¼ï¼Œæ ¹æ®éœ€è¦è°ƒæ•´
        }
      }
      // æ·»åŠ é‡ç½®è§†å›¾æŒ‰é’®çš„åŠŸèƒ½

      // åˆ‡æ¢ä¸­æ–‡æ¨¡å¼
      var isChineseMode = false;
      function toggleLanguage() {
        isChineseMode = !isChineseMode;
        var elementsToTranslate = {
          "structure-button": ["Structure", "æ•´é«”çµæ§‹"],
          "tank-button": ["Tank", "è—»ç¼¸"],
          "control-box-button": ["Control Box", "æ§åˆ¶ç®±"],
          "implode-all-button": ["Implode All", "æ¨¡å‹é‡çµ„"],
          dayMode: ["Day Mode", "æ—¥é–“æ¨¡å¼"],
          duskMode: ["Dusk Mode", "é»„æ˜æ¨¡å¼"],
          nightMode: ["Night Mode", "å¤œé–“æ¨¡å¼"],
          zenMode: ["Zen Mode", "ç©ºç„¡æ¨¡å¼"],
          toggleModelRotation: ["Toggle Model Rotation", "æ¨¡å‹æ—‹è½‰"],
          resetViewButton: ["Reset View", "é‡ç½®è¦–åœ–"],
          languageToggleButton: ["English Mode", "ä¸­æ–‡æ¨¡å¼"],
          infoText: [
            "<strong><p>Use mouse to rotate and zoom</p><p>Shift + Drag to pan</p></strong>",
            "<strong><p>ä½¿ç”¨æ»‘é¼ æ—‹è½‰å’Œç¸®æ”¾</p><p>Shift + æ‹–æ›³ä¾†å¹³ç§»</p></strong>"
          ],

          explodeModelTitle: [
            "<strong>Explode Model</strong>",
            "<strong>æ¨¡å‹çˆ†ç‚¸åœ–</strong>"
          ],
          backgroundSceneTitle: [
            "<strong>Background Scene</strong>",
            "<strong>èƒŒæ™¯å ´æ™¯è¨­å®š</strong>"
          ],
          rotationTitle: [
            "<strong>Rotation</strong>",
            "<strong>æ—‹è½‰èˆ‡é‡ç½®</strong>"
          ],
          rotateSpeedControllerLabel: [
            "Rotate Speed Controller",
            "æ—‹è½‰é€Ÿåº¦æ§åˆ¶å™¨"
          ],
          colorTitle: [
            "<strong>Color Customization</strong>",
            "<strong>é¡è‰²è‡ªè¨‚</strong>"
          ]
        };

        for (var key in elementsToTranslate) {
          var element = document.getElementById(key);
          if (element) {
            element.innerHTML = isChineseMode
              ? elementsToTranslate[key][1]
              : elementsToTranslate[key][0];
          }
        }
        adjustInfoTextPosition();
      }

      toggleLanguage(); // åˆå§‹è°ƒç”¨ä»¥è®¾ç½®æ­£ç¡®çš„è¯­è¨€æ¨¡å¼
      // å…¶ä»– JavaScript ä»£ç 

      // Central function to manage camera position and rotation
    </script>
  </body>
</html>
